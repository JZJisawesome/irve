# CMakeLists.txt
# Copyright (C) 2023 John Jekel and Nick Chan
# See the LICENSE file at the root of the project for licensing info.
#
# CMake configuration file for irve testfile verification and parsing tests
#
# Based on CMakeLists.txt from rv32esim
#

#Common options
cmake_minimum_required(VERSION 3.16.3)
include(CTest)

set(
    TESTFILES_TESTER_SOURCES
    ${CMAKE_CURRENT_BINARY_DIR}/testfiles_verifier.cpp
    ${CMAKE_CURRENT_SOURCE_DIR}/jzjcoresoftware.cpp
    ${CMAKE_CURRENT_SOURCE_DIR}/rv32esim.cpp
)

add_executable(testfiles_verifier ${TESTFILES_TESTER_SOURCES})
target_include_directories(testfiles_verifier PRIVATE ${PROJECT_SOURCE_DIR}/include/)#To get access to the public libirve headers
#Testfiles tests need access to the internal libirve headers (including the autogenerated ones)
target_include_directories(testfiles_verifier PRIVATE ${PROJECT_SOURCE_DIR}/lib/ ${CMAKE_BINARY_DIR}/lib)
target_link_libraries(testfiles_verifier PRIVATE libirve_object)#TODO or should we make this static or shared instead?
#add_dependencies(testfiles_verifier irve_testfiles)#We depend on the testfiles being generated#FIXME express dependency of testfiles_tester on testfiles being compiled
set(TESTFILES_TEST_LIST "")
macro(add_testfiles_test TEST_NAME)
    #The working directory is important because tests will need to access the testfiles
    add_test(NAME testfiles_${TEST_NAME} COMMAND testfiles_verifier ${TEST_NAME} WORKING_DIRECTORY "${PROJECT_SOURCE_DIR}/testfiles/compiled")
    set(TESTFILES_TEST_LIST "${TESTFILES_TEST_LIST} X(${TEST_NAME})")
    set_property(TEST testfiles_${TEST_NAME} PROPERTY REQUIRED_FILES "$<TARGET_FILE:testfiles_verifier>")
endmacro()
macro(add_testfiles_parse_test TEST_NAME)#Useful for C tests that have assertions in RISC-V code rather than in testfiles_verifier
    add_test(NAME testfiles_parse_${TEST_NAME} COMMAND irve ${TEST_NAME}.hex WORKING_DIRECTORY "${PROJECT_SOURCE_DIR}")
    set_property(TEST testfiles_parse_${TEST_NAME} PROPERTY PASS_REGULAR_EXPRESSION "IRVE is shutting down. Bye bye!")
    #The way we did assertions pre-newlib and Newlib-style respectively
    set_property(TEST testfiles_parse_${TEST_NAME} PROPERTY FAIL_REGULAR_EXPRESSION "Assertion failed;assertion \".*\" failed")
    set_property(TEST testfiles_parse_${TEST_NAME} PROPERTY REQUIRED_FILES "$<TARGET_FILE:irve>")
endmacro()
macro(add_unit_test)
    #Do nothing
endmacro()
macro(add_integration_test)
    #Do nothing
endmacro()

include(${CMAKE_CURRENT_SOURCE_DIR}/../test_list.txt)

#Put the list of testfiles tests in the testfiles tester file (THIS MUST COME AFTER INCLUDING THE TEST LIST)
configure_file(
    ${CMAKE_CURRENT_SOURCE_DIR}/testfiles_verifier.cpp.in
    ${CMAKE_CURRENT_BINARY_DIR}/testfiles_verifier.cpp
    @ONLY
)
